# Threads, mécanismes de synchronisation

#### Ex1.

On reprend l'exercice du tp3 sur la séquentilisation de tâches. Des threads affichent en boucle leur message ("1111","2222","3333","4444", etc. ) caractère par caractère. Le but est de séquentialiser leur éxecution afin d'obtenir l'affichage

```text
11112222333344445555 ... 
```

(sans entrelacement, et dans l'ordre). Il y a des sources à compléter [ici](https://dwarves.iut-fbleau.fr/gitiut/FA2_2021/ASR31/src/branch/master/tp/tp11/src/sequentialisation)

- Donner une solution en utilisant une variable partagée `tour`, un mutex et une variable condition.
  Cette solution est-elle "optimale" ?
- Donner une solution en utilisant un sémaphore (posix) pour chaque thread.
- Comparer les temps d'éxecution, et expliquez la différence.

#### Ex2.

Producteurs/Consommateurs.

Une vitrine contient des bonbons. Elle a une capacité maximale `MB`. Des producteurs et des consommateurs fabriquent et mangent des bonbons dans la vitrine. Programmez, à l'aide de threads, ce modèle de concurrence. Votre programme prendra en argument :

- le nombre de producteurs.
- le nombre de consommateurs.
- la quantité initiale de bonbons dans la vitrine.
- une durée deltap et deltac en ms.

La vie d'un consommateur et d'un producteur est relativement simple. En boucle,

- le producteur produit (s'il peut) une quantité aléatoire de bonbons, puis dort pendant (plus ou moins) `deltap` ms.
- le consommateur mange (s'il peut) une quantité aléatoire de bonbons, puis dort pendant (plus ou moins) `deltac` ms.

A chaque consommation ou production de bonbons dans la vitrine, vous devez affichez le nombre de bonbons après cette action.

Prévoyez un affichage (pas trop bavard) qui permet de tracer le fonctionnement du système. Il vous faut également mettre en oeuvre les mécanismes de synchronisations nécessaires (mutex et conditions).

```bash
./prodcons <nb_prod> <nb_cons> <nb_bonbons> <deltap> <deltac>
[denis@portabledenis prodcons]$ ./a.out 10 10 10 100000 500000
producteur (42560)   ->  03 : Vitrine :  13 [ *************------- ]
producteur (26176)   ->  05 : Vitrine :  18 [ ******************-- ]
producteur ( 9792)   ->  02 : Vitrine :  20 [ ******************** ]
consommateur ( 1600) ->  05 : Vitrine :  15 [ ***************----- ]
consommateur (46656) ->  05 : Vitrine :  10 [ **********---------- ]
producteur (30272)   ->  05 : Vitrine :  15 [ ***************----- ]
consommateur (50752) ->  03 : Vitrine :  12 [ ************-------- ]
producteur (38464)   ->  08 : Vitrine :  20 [ ******************** ]
consommateur (54848) ->  08 : Vitrine :  12 [ ************-------- ]
producteur (34368)   ->  05 : Vitrine :  17 [ *****************--- ]
consommateur ( 5696) ->  08 : Vitrine :   9 [ *********----------- ]
producteur (46656)   ->  10 : Vitrine :  19 [ *******************- ]
consommateur (34368) ->  07 : Vitrine :  12 [ ************-------- ]
consommateur (63040) ->  09 : Vitrine :   3 [ ***----------------- ]
producteur (22080)   ->  10 : Vitrine :  13 [ *************------- ]
consommateur (58944) ->  07 : Vitrine :   6 [ ******-------------- ]
producteur (42560)   ->  05 : Vitrine :  11 [ ***********--------- ]
```

#### Ex3.

Le problème du [dîner des philosphes](https://fr.wikipedia.org/wiki/Dîner_des_philosophes) est un problème classique de synchronisation (énoncé par [Dijkstra](https://fr.wikipedia.org/wiki/Edsger_Dijkstra)).

![img](https://dwarves.iut-fbleau.fr/gitiut/FA2_2021/ASR31/media/branch/master/tp/tp3/img/philosophe.png)

`n` philosophes, assis autour d'une table, participent à un dîner. Chaque philosophe peut-être dans un des trois états `Pense`,`A Faim` ou `Mange`.

Il y a `n` assiettes et `n` baguettes. Pour manger, un philosophe a besoin des deux baguettes adjacentes à son assiette. **Deux philosophes voisins ne peuvent donc pas manger en même temps**. Chaque philosophe est un thread qui boucle :

```c
while(1){
  penser(); // le philosphe pense
  prendre_baguettes(); // le philosophe a faim
  manger(); // le philosophe mange
  poser_baguettes();
}
```

Les philosophes sont des gens courtois. Ils commenseront d'abord par s'attendre avant de commencer le repas.

Vous devez utiliser les mutex et conditions pour synchroniser leur activité :

Pour pouvoir manger, chaque philosophe a besoin de deux baguettes. On utilisera :

- un tableau de booléen pour qui mémorise l'état des fourchettes (libre ou prise),
- un mutex,
- une variable condition pour chaque philosophe.

Pour que la trace d'exécution puisse permettre de suivre (à peu près) correctement l'évolution des activités, vous pouvez :

- sur la sortie standard écrire des "messages" qui traduisent le changement d'états d'un philosophe,
- écrire un programme qui les consomme et qui affiche systématiquement, les différents états de chaque philosophe à chaque message reçu.

Par exemple,

```bash
[denis@portabledenis philosophe]$ ./philo 5 | ./affiche 5
 pense : .......... a faim : .......... mange : ..........
 pense : 0......... a faim : .......... mange : ..........
 pense : 0.1....... a faim : .......... mange : ..........
 pense : 0.1.2..... a faim : .......... mange : ..........
 pense : 0.1.2.3... a faim : .......... mange : ..........
 pense : 0.1.2.3.4. a faim : .......... mange : ..........
 pense : 0...2.3.4. a faim : ..1....... mange : ..........
 pense : 0...2.3.4. a faim : .......... mange : ..1.......
 pense : 0...2.3... a faim : ........4. mange : ..1.......
 pense : 0...2.3... a faim : .......... mange : ..1.....4.
 pense : 0...2.3.4. a faim : .......... mange : ..1.......
 pense : ....2.3.4. a faim : 0......... mange : ..1.......
 pense : ......3.4. a faim : 0...2..... mange : ..1.......
 pense : ........4. a faim : 0...2.3... mange : ..1.......
 pense : ........4. a faim : 0...2..... mange : ..1...3...
 pense : ......3.4. a faim : 0...2..... mange : ..1.......
 pense : ..1...3.4. a faim : 0...2..... mange : ..........
 pense : ..1...3.4. a faim : ....2..... mange : 0.........
 pense : ..1...3.4. a faim : .......... mange : 0...2.....
 pense : ..1...3... a faim : ........4. mange : 0...2.....
 pense : ..1....... a faim : ......3.4. mange : 0...2.....
 pense : ..1.2..... a faim : ......3.4. mange : 0.........
 pense : ..1.2..... a faim : ........4. mange : 0.....3...
 pense : ..1....... a faim : ....2...4. mange : 0.....3...
 pense : .......... a faim : ..1.2...4. mange : 0.....3...
 pense : 0......... a faim : ..1.2...4. mange : ......3...
 pense : 0......... a faim : ....2...4. mange : ..1...3...
 pense : 0.....3... a faim : ....2...4. mange : ..1.......
 pense : 0.....3... a faim : ....2..... mange : ..1.....4.
 pense : ......3... a faim : 0...2..... mange : ..1.....4.
 pense : .......... a faim : 0...2.3... mange : ..1.....4.
 pense : ........4. a faim : 0...2.3... mange : ..1.......
 pense : ........4. a faim : 0...2..... mange : ..1...3...
 pense : ..1.....4. a faim : 0...2..... mange : ......3...
 pense : ..1.....4. a faim : ....2..... mange : 0.....3...
 pense : 0.1.....4. a faim : ....2..... mange : ......3...
 pense : 0.1...3.4. a faim : ....2..... mange : ..........
 pense : 0.1...3.4. a faim : .......... mange : ....2.....
 pense : 0.1...3... a faim : ........4. mange : ....2.....
 pense : 0.1...3... a faim : .......... mange : ....2...4.
 pense : 0.1...3.4. a faim : .......... mange : ....2.....
 pense : 0.1.....4. a faim : ......3... mange : ....2.....
 pense : 0.1.2...4. a faim : ......3... mange : ..........
 pense : 0.1.2...4. a faim : .......... mange : ......3...
 pense : 0...2...4. a faim : ..1....... mange : ......3...
 pense : 0...2...4. a faim : .......... mange : ..1...3...
 pense : ....2...4. a faim : 0......... mange : ..1...3...
 pense : ....2.3.4. a faim : 0......... mange : ..1.......
 pense : ......3.4. a faim : 0...2..... mange : ..1.......
 pense : ..1...3.4. a faim : 0...2..... mange : ..........
 pense : ..1...3.4. a faim : ....2..... mange : 0.........
 pense : ..1...3.4. a faim : .......... mange : 0...2.....
 pense : ..1...3... a faim : ........4. mange : 0...2.....
 pense : ..1....... a faim : ......3.4. mange : 0...2.....
 pense : .......... a faim : ..1...3.4. mange : 0...2.....
 pense : ....2..... a faim : ..1...3.4. mange : 0.........
 pense : ....2..... a faim : ..1.....4. mange : 0.....3...
```

Proposer une solution qui utilise **uniquement** des sémaphores posix.